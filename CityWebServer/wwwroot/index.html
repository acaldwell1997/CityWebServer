<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>City Statistics</title>
    <link href='//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css' rel='stylesheet'>
    <style type="text/css">
        body { padding-top: 50px; }
    </style>
</head>
<body>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="/"><span data-bind="text: Name"></span></a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/Log">Log</a></li>
                    <li><a href="/Budget">Budget</a></li>
                    <li><a href="/Building">Building</a></li>
                    <li><a href="/Messages">Chirper Messages</a></li>
                    <li><a href="/CityInfo">City Info</a></li>
                    <li><a href="/Transport">Transport</a></li>
                    <li><a href="/Vehicle">Vehicle</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <h1><span data-bind="text: Name"></span>'s City Statistics</h1>
        <div id="chart"></div>
	<input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search for names..">
        <table id="mainDataTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Name</th>
                    <th onclick="sortTable(1)">Population</th>
		    <th onclick="sortTable(2)">Weekly Tourists</th>
                    <th onclick="sortTable(3)">Households (Max)</th>
		    <th onclick="sortTable(4)">Jobs (Max)</th>
		    <th onclick="sortTable(5)">Household Fullness</th>
                    <th onclick="sortTable(6)">Job Fullness</th>
		    <!--<th>City Domination*</th>-->
                    <th onclick="sortTable(7)">Tourist Saturation</th>
                    <th onclick="sortTable(8)">Land Value</th>
                    <th onclick="sortTable(9)">Pollution</th>
                </tr>
            </thead>
            <tbody>

            <!-- ko foreach: Districts -->
            <tr>
                <td data-bind="text: DistrictName"></td>
                <td><span data-bind="text: TotalPopulationCount"></span></td>
		<td data-bind="text: WeeklyTouristVisits"></td>
                <td><span data-bind="text: CurrentHouseholds"></span> (<span data-bind="text: AvailableHouseholds"></span>)</td>
		<td><span data-bind="text: CurrentJobs"></span> (<span data-bind="text: AvailableJobs"></span>)</td>
		<td><span data-bind="text: (((CurrentHouseholds() / AvailableHouseholds()) * 100).toFixed(2)) + '%'"></td>
		<td><span data-bind="text: (((CurrentJobs() / AvailableJobs())) * 100).toFixed(2) + '%'"></span></td>
		<td><span data-bind="text: ((WeeklyTouristVisits() / TotalPopulationCount()) * 100).toFixed(2) + '%'"></span></td>
                <td data-bind="text: '₡' + AverageLandValue()"></td>
                <td data-bind="text: (Pollution() * 100).toFixed(0) + '%'"></td>
            </tr>
            <!-- /ko -->
            </tbody>
            <tfoot>
                <tr>
                    <td><strong>Total</strong></td>
                    <td><span data-bind="text: GlobalDistrict.TotalPopulationCount"></span></td>
                    <td><span data-bind="text: GlobalDistrict.CurrentHouseholds"></span> (<span data-bind="text: GlobalDistrict.AvailableHouseholds"></span>)</td>
		    <td><span data-bind="text: GlobalDistrict.CurrentJobs"></span> (<span data-bind="text: GlobalDistrict.AvailableJobs"></span>)</td>
		    <td data-bind="text: GlobalDistrict.WeeklyTouristVisits"></td>
		    <td><span data-bind="text: (((GlobalDistrict.CurrentHouseholds() / GlobalDistrict.AvailableHouseholds())) * 100).toFixed(2) + '%'"></span></td>
                    <td><span data-bind="text: (((GlobalDistrict.CurrentJobs() / GlobalDistrict.AvailableJobs())) * 100).toFixed(2) + '%'"></span></td>
                    <td><span data-bind="text: ((GlobalDistrict.WeeklyTouristVisits() / GlobalDistrict.TotalPopulationCount()) * 100).toFixed(2) + '%'"></span></td>
                    <td data-bind="text: '₡' + GlobalDistrict.AverageLandValue()"></td>
                    <td data-bind="text: (GlobalDistrict.Pollution() * 100).toFixed(0) + '%'"></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <footer class="footer">
	<div class="container">
	      <p class="text-muted"> * City Domination is a comparision between the specified distict and the rest of the city.</p>	
        </div>
    </footer>
    <script src='./jquery-2.1.3.min.js'></script>
    <script src='./bootstrap.min.js'></script>
    <script src='./knockout-3.3.0.js'></script>
    <script src='./knockout.mapping-latest.js'></script>
    <script src="./highcharts.js"></script>
    <script src="./script.js"></script>
    <script scr="./history.js"></script>
    
    <script type="text/javascript">

    var endpoint = "./CityInfo";
    var viewModel;
    var chart;
    var chart2;
    var initialized = false;
    var lastDate;
    let history = [];
    
    
    // Update the data once every second.
    window.setInterval(function ()
    {
        $.getJSON(endpoint, function(data) {
            if (initialized) {
                ko.mapping.fromJS(data, viewModel);
                if (lastDate !== viewModel.Time()) {
                    updateChart(viewModel, chart);
                    lastDate = viewModel.Time();
                } else {
                    console.log("Same Date: " + lastDate);
                }
            } else {
                initialized = true;
                viewModel = ko.mapping.fromJS(data);
                ko.applyBindings(viewModel);
                chart = initializeSplineChart(viewModel);
            }
        });
    }, 2000); // Every two seconds.

	function appendHistoryTable(){
		console.log(history)
	}
    </script>

<script>
function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("mainDataTable");
  switching = true;
  //Set the sorting direction to ascending:
  dir = "asc"; 
  /*Make a loop that will continue until
  no switching has been done:*/
  while (switching) {
    //start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /*Loop through all table rows (except the
    first, which contains table headers):*/
    for (i = 1; i < (rows.length - 1); i++) {
      //start by saying there should be no switching:
      shouldSwitch = false;
      /*Get the two elements you want to compare,
      one from current row and one from the next:*/
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /*check if the two rows should switch place,
      based on the direction, asc or desc:*/
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          //if so, mark as a switch and break the loop:
          shouldSwitch= true;
          break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          //if so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /*If a switch has been marked, make the switch
      and mark that a switch has been done:*/
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      //Each time a switch is done, increase this count by 1:
      switchcount ++;      
    } else {
      /*If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again.*/
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}
</script>
<script>
function filterTable() {
  // Declare variables
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById("searchInput");
  filter = input.value.toUpperCase();
  table = document.getElementById("mainDataTable");
  tr = table.getElementsByTagName("tr");

  // Loop through all table rows, and hide those who don't match the search query
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[0];
    if (td) {
      txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }
  }
}
</script>
</body>
</html>
